# 🏠 本地部署完整指南

## 快速开始（3步完成）

### 准备工作
1. 确保已构建项目：`npm run build`
2. 以管理员身份打开PowerShell

### 第一步：运行自动化安装脚本

```powershell
# 以管理员身份运行PowerShell
.\LOCAL-SETUP.ps1
```

这个脚本会自动：
- ✅ 安装IIS
- ✅ 部署应用到IIS
- ✅ 下载GitHub Runner

### 第二步：配置GitHub Runner

1. 访问：https://github.com/come150/iis-login-app/settings/actions/runners/new

2. 点击页面上的任意选项（Linux/macOS/Windows），会显示配置命令

3. 复制命令中的Token（`--token` 后面的值）

4. 在PowerShell中运行：

```powershell
cd C:\actions-runner

# 配置Runner（替换YOUR_TOKEN）
.\config.cmd --url https://github.com/come150/iis-login-app --token YOUR_TOKEN --name "Local-PC" --labels "self-hosted,windows,iis" --unattended

# 安装为服务
.\svc.cmd install

# 启动服务
.\svc.cmd start

# 检查状态
.\svc.cmd status
```

### 第三步：配置GitHub Secrets

访问：https://github.com/come150/iis-login-app/settings/secrets/actions

点击 "New repository secret"，添加4个：

| Name | Value |
|------|-------|
| `IIS_SITE_NAME` | `Default Web Site` |
| `IIS_SITE_PATH` | `C:\inetpub\wwwroot` |
| `BACKUP_PATH` | `C:\IISBackups` |
| `HEALTH_CHECK_URL` | `http://localhost` |

---

## 验证部署

### 1. 测试本地IIS

打开浏览器访问：http://localhost

应该能看到登录页面，测试登录：
- 用户名: `admin` / 密码: `admin123`
- 用户名: `user` / 密码: `user123`

### 2. 检查Runner状态

访问：https://github.com/come150/iis-login-app/settings/actions/runners

应该看到你的Runner显示为 **Idle**（绿色圆点）

### 3. 触发自动部署

访问：https://github.com/come150/iis-login-app/actions

点击 **"Manual Deploy"** > **"Run workflow"**

选择：
- Environment: `production`
- 其他保持默认

点击 **"Run workflow"** 开始部署

### 4. 查看部署日志

在Actions页面点击运行中的工作流，查看实时日志。

部署成功后，刷新 http://localhost 验证更新。

---

## 手动安装IIS（如果脚本失败）

### Windows 10/11

1. 打开 **控制面板** > **程序** > **启用或关闭Windows功能**

2. 勾选以下项目：
   - ✅ Internet Information Services
   - ✅ Web管理工具
   - ✅ 万维网服务
   - ✅ 应用程序开发功能

3. 点击 **确定**，等待安装完成

4. 打开浏览器访问 http://localhost 验证

### 使用PowerShell命令

```powershell
# 以管理员身份运行
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole -All
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServer -All
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CommonHttpFeatures -All
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ManagementConsole -All
```

---

## 手动部署应用到IIS

```powershell
# 1. 构建项目
npm run build

# 2. 复制文件到IIS
Copy-Item -Path ".\dist\*" -Destination "C:\inetpub\wwwroot\" -Recurse -Force

# 3. 启动IIS
Start-Service W3SVC

# 4. 访问测试
Start-Process "http://localhost"
```

---

## 常见问题

### ❌ 问题1：无法访问 http://localhost

**解决方案：**
```powershell
# 检查IIS服务
Get-Service W3SVC

# 启动IIS
Start-Service W3SVC

# 检查防火墙
# 控制面板 > Windows Defender 防火墙 > 允许应用通过防火墙
# 确保 "万维网服务(HTTP)" 已勾选
```

### ❌ 问题2：Runner无法启动

**解决方案：**
```powershell
# 查看Runner日志
Get-Content "C:\actions-runner\_diag\Runner_*.log" -Tail 50

# 重新配置
cd C:\actions-runner
.\config.cmd remove
.\config.cmd --url https://github.com/come150/iis-login-app --token NEW_TOKEN
```

### ❌ 问题3：部署时权限不足

**解决方案：**
```powershell
# 授予Runner权限
icacls "C:\inetpub\wwwroot" /grant "Everyone:(OI)(CI)F" /T

# 或者授予当前用户权限
icacls "C:\inetpub\wwwroot" /grant "$env:USERNAME:(OI)(CI)F" /T
```

### ❌ 问题4：需要重启电脑

安装IIS后可能需要重启。重启后：
1. 重新运行 `.\LOCAL-SETUP.ps1`
2. 或手动启动IIS：`Start-Service W3SVC`

---

## 测试自动部署流程

### 1. 修改代码

```powershell
# 修改登录页面标题
$indexPath = ".\src\index.html"
(Get-Content $indexPath) -replace '<title>用户登录</title>', '<title>用户登录 v2.0</title>' | Set-Content $indexPath
```

### 2. 提交并推送

```powershell
git add .
git commit -m "更新登录页面标题"
git push origin main
```

### 3. 查看自动部署

访问：https://github.com/come150/iis-login-app/actions

应该自动触发部署工作流。

### 4. 验证更新

部署完成后，刷新 http://localhost，查看标题是否更新。

---

## 🎉 完成检查清单

- [ ] IIS已安装并运行
- [ ] 本地可以访问 http://localhost
- [ ] 登录功能正常工作
- [ ] GitHub Runner已安装并运行
- [ ] Runner在GitHub显示为Idle
- [ ] GitHub Secrets已配置
- [ ] 手动触发部署成功
- [ ] 推送代码自动触发部署
- [ ] 部署后网站自动更新

---

## 下一步

完成本地部署后，你可以：

1. **学习工作流配置**
   - 查看 `.github/workflows/` 目录
   - 修改部署流程

2. **添加更多功能**
   - 用户注册
   - 密码加密
   - 数据库集成

3. **部署到生产服务器**
   - 使用相同的方法在远程服务器上配置
   - 配置HTTPS
   - 设置域名

4. **优化部署流程**
   - 添加自动化测试
   - 配置多环境部署
   - 集成通知系统
