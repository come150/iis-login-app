# 新项目快速配置指南

在新项目中使用GitHub Actions + Self-hosted Runner自动化部署IIS

## 第一步：复制必要文件

从当前项目复制以下文件到新项目：

```powershell
# 在新项目根目录执行

# 1. 创建.github/workflows目录
mkdir .github\workflows

# 2. 复制工作流文件
copy "E:\github\GitHub Self-hosted Runner\.github\workflows\manual-deploy.yml" .github\workflows\

# 3. 可选：复制其他辅助脚本
mkdir scripts
copy "E:\github\GitHub Self-hosted Runner\scripts\deploy-to-iis.ps1" scripts\
```

## 第二步：修改工作流配置

编辑 `.github/workflows/manual-deploy.yml`，修改以下路径：

### 需要修改的地方：

```yaml
# 第15-16行：修改为新项目的路径
$sourcePath = "你的新项目路径\src"  # 例如：E:\projects\new-project\src
$distPath = "你的新项目路径\dist"    # 例如：E:\projects\new-project\dist

# 第30行：修改源路径
$sourcePath = "你的新项目路径\dist"
```

### 完整示例：

假设新项目在 `E:\projects\my-new-app`，修改为：

```yaml
- name: 准备部署文件
  run: |
    $sourcePath = "E:\projects\my-new-app\src"
    $distPath = "E:\projects\my-new-app\dist"
    
    if (Test-Path $distPath) { Remove-Item $distPath -Recurse -Force }
    Copy-Item -Path $sourcePath -Destination $distPath -Recurse
    Write-Host "✓ 部署文件已准备" -ForegroundColor Green
  shell: powershell

- name: 部署到IIS
  shell: powershell
  run: |
    Write-Host "========== 开始部署 ==========" -ForegroundColor Cyan
    
    $sitePath = "${{ secrets.IIS_SITE_PATH }}"
    $sourcePath = "E:\projects\my-new-app\dist"
    
    Write-Host "站点路径: $sitePath"
    Write-Host "源路径: $sourcePath"
    
    Write-Host "复制文件..."
    Copy-Item -Path "$sourcePath\*" -Destination $sitePath -Recurse -Force
    
    Write-Host "========== 部署完成 ==========" -ForegroundColor Green
```

## 第三步：创建GitHub仓库

```powershell
# 在新项目目录
git init
git add .
git commit -m "初始化项目"

# 在GitHub创建新仓库后
git remote add origin https://github.com/你的用户名/新项目名.git
git branch -M main
git push -u origin main
```

## 第四步：配置GitHub Secrets

访问：`https://github.com/你的用户名/新项目名/settings/secrets/actions`

添加Secrets（如果IIS站点不同，修改对应值）：

| Name | Value | 说明 |
|------|-------|------|
| `IIS_SITE_NAME` | `Default Web Site` | IIS站点名称 |
| `IIS_SITE_PATH` | `C:\inetpub\wwwroot\新项目` | 新项目的IIS路径 |
| `BACKUP_PATH` | `C:\IISBackups` | 备份目录 |
| `HEALTH_CHECK_URL` | `http://localhost/新项目` | 健康检查URL |

## 第五步：配置Runner（两种方式）

### 方式A：使用现有Runner（推荐）

如果新项目部署到同一台服务器，**不需要重新安装Runner**，现有的Runner可以服务多个仓库。

只需要在GitHub上授权：

1. 访问：`https://github.com/你的用户名/新项目名/settings/actions/runners`
2. 点击 "New self-hosted runner"
3. 会看到现有的Runner（如果在同一个组织下）
4. 或者使用相同的Runner标签 `self-hosted,windows,iis`

### 方式B：为新项目单独配置Runner

如果需要单独的Runner：

```powershell
# 在IIS服务器上，以管理员身份运行

# 1. 创建新的Runner目录
mkdir C:\actions-runner-newproject
cd C:\actions-runner-newproject

# 2. 下载Runner（使用最新版本）
Invoke-WebRequest -Uri https://github.com/actions/runner/releases/download/v2.321.0/actions-runner-win-x64-2.321.0.zip -OutFile actions-runner.zip

# 3. 解压
Expand-Archive -Path actions-runner.zip -DestinationPath . -Force

# 4. 配置（从GitHub页面获取token）
.\config.cmd --url https://github.com/你的用户名/新项目名 --token YOUR_TOKEN --name "NewProject-Runner" --labels "self-hosted,windows,iis"

# 5. 安装为服务
.\svc.cmd install

# 6. 启动服务
.\svc.cmd start
```

## 第六步：测试部署

1. 访问：`https://github.com/你的用户名/新项目名/actions`
2. 点击 "Manual Deploy"
3. 点击 "Run workflow"
4. 选择 `production`
5. 点击 "Run workflow"

## 快速模板

### 最小化工作流模板

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to IIS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: 部署到IIS
        shell: powershell
        run: |
          # 修改这两个路径
          $sourcePath = "你的项目路径\src"
          $targetPath = "${{ secrets.IIS_SITE_PATH }}"
          
          Write-Host "开始部署..."
          Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
          Write-Host "部署完成！"
```

## 常见场景

### 场景1：多个项目共用一个Runner

```yaml
# 项目A的工作流
$sourcePath = "E:\projects\project-a\src"

# 项目B的工作流
$sourcePath = "E:\projects\project-b\src"

# 项目C的工作流
$sourcePath = "E:\projects\project-c\src"
```

### 场景2：不同的IIS站点

为每个项目配置不同的Secrets：

- 项目A: `IIS_SITE_PATH` = `C:\inetpub\wwwroot\project-a`
- 项目B: `IIS_SITE_PATH` = `C:\inetpub\wwwroot\project-b`
- 项目C: `IIS_SITE_PATH` = `C:\inetpub\wwwroot\project-c`

### 场景3：需要构建的项目（如React/Vue）

```yaml
- name: 构建项目
  run: |
    npm install
    npm run build
  shell: powershell

- name: 部署到IIS
  run: |
    $sourcePath = ".\build"  # 或 .\dist
    $targetPath = "${{ secrets.IIS_SITE_PATH }}"
    Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
  shell: powershell
```

## 检查清单

新项目配置完成后，确认：

- [ ] `.github/workflows/manual-deploy.yml` 已创建
- [ ] 工作流中的路径已修改为新项目路径
- [ ] GitHub仓库已创建并推送代码
- [ ] GitHub Secrets已配置（4个）
- [ ] Runner已配置（使用现有或新建）
- [ ] 手动触发部署测试成功
- [ ] 访问网站验证部署结果

## 故障排查

### 问题：Runner找不到

**解决方案：**
- 确保Runner服务正在运行：`Get-Service "actions.runner.*"`
- 检查Runner标签是否匹配：`self-hosted,windows,iis`

### 问题：路径错误

**解决方案：**
- 使用绝对路径
- 路径中的空格用引号包裹
- 检查路径是否存在：`Test-Path "你的路径"`

### 问题：权限不足

**解决方案：**
```powershell
# 授予Runner权限
icacls "C:\inetpub\wwwroot\新项目" /grant "NT AUTHORITY\NETWORK SERVICE:(OI)(CI)F" /T
```

## 进阶配置

### 添加自动触发（推送时自动部署）

```yaml
on:
  push:
    branches:
      - main
  workflow_dispatch:
```

### 添加环境变量

```yaml
env:
  PROJECT_PATH: "E:\projects\my-new-app"
  
steps:
  - name: 部署
    run: |
      $sourcePath = "${{ env.PROJECT_PATH }}\src"
```

### 添加通知

```yaml
- name: 部署成功通知
  if: success()
  run: |
    Write-Host "✅ 部署成功！" -ForegroundColor Green
    # 可以添加邮件、Slack等通知
```

## 总结

新项目配置只需要：
1. 复制工作流文件
2. 修改项目路径
3. 配置GitHub Secrets
4. 使用现有Runner或新建
5. 测试部署

整个过程5-10分钟即可完成！
