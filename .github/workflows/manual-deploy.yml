name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '选择部署环境'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: '版本号或Git标签（可选）'
        required: false
        type: string
      skip_tests:
        description: '跳过测试'
        required: false
        type: boolean
        default: false

jobs:
  manual-deploy:
    runs-on: self-hosted
    
    steps:
      - name: 显示部署信息
        run: |
          Write-Host "========== 开始部署 ==========" -ForegroundColor Cyan
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Yellow
        shell: powershell
      
      - name: 准备部署文件
        run: |
          # 使用本地已有的代码（Runner工作目录）
          $sourcePath = "E:\github\GitHub Self-hosted Runner\src"
          $distPath = "E:\github\GitHub Self-hosted Runner\dist"
          
          if (Test-Path $distPath) { Remove-Item $distPath -Recurse -Force }
          Copy-Item -Path $sourcePath -Destination $distPath -Recurse
          Write-Host "✓ 部署文件已准备" -ForegroundColor Green
        shell: powershell
      
      - name: 部署到IIS
        shell: powershell
        run: |
          Write-Host "========== 开始部署到IIS ==========" -ForegroundColor Cyan
          
          Import-Module WebAdministration
          
          $siteName = "${{ secrets.IIS_SITE_NAME }}"
          $sitePath = "${{ secrets.IIS_SITE_PATH }}"
          $sourcePath = "E:\github\GitHub Self-hosted Runner\dist"
          
          Write-Host "站点名称: $siteName" -ForegroundColor Yellow
          Write-Host "站点路径: $sitePath" -ForegroundColor Yellow
          Write-Host "源路径: $sourcePath" -ForegroundColor Yellow
          
          # 获取应用程序池
          $site = Get-Website -Name $siteName
          $appPoolName = $site.applicationPool
          Write-Host "应用程序池: $appPoolName" -ForegroundColor Yellow
          
          # 停止服务
          Write-Host "停止应用程序池..." -ForegroundColor Yellow
          Stop-WebAppPool -Name $appPoolName
          Start-Sleep -Seconds 3
          
          Write-Host "停止站点..." -ForegroundColor Yellow
          Stop-Website -Name $siteName
          Start-Sleep -Seconds 2
          
          # 部署文件
          Write-Host "清理旧文件..." -ForegroundColor Yellow
          Get-ChildItem -Path $sitePath | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          
          Write-Host "复制新文件..." -ForegroundColor Yellow
          Copy-Item -Path "$sourcePath\*" -Destination $sitePath -Recurse -Force
          
          # 启动服务
          Write-Host "启动站点..." -ForegroundColor Yellow
          Start-Website -Name $siteName
          Start-Sleep -Seconds 2
          
          Write-Host "启动应用程序池..." -ForegroundColor Yellow
          Start-WebAppPool -Name $appPoolName
          Start-Sleep -Seconds 3
          
          Write-Host "========== 部署完成 ==========" -ForegroundColor Green
      
      - name: 部署成功通知
        if: success()
        run: |
          Write-Host "========== 部署成功 ==========" -ForegroundColor Green
          Write-Host "环境: ${{ github.event.inputs.environment }}" -ForegroundColor Cyan
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Cyan
        shell: powershell
      
      - name: 部署失败通知
        if: failure()
        run: |
          Write-Host "========== 部署失败 ==========" -ForegroundColor Red
          Write-Host "请检查日志并联系管理员" -ForegroundColor Yellow
        shell: powershell
