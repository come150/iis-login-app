name: Send Email Test via Quant.Infra.Net

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: '测试名称'
        required: false
        type: string
        default: 'MVP_SendCommercial'

jobs:
  email-test:
    runs-on: self-hosted
    
    steps:
      - name: 配置Git代理
        run: |
          git config --global http.proxy http://127.0.0.1:10809
          git config --global https.proxy http://127.0.0.1:10809
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          Write-Host "✓ Git代理已配置" -ForegroundColor Green
        shell: powershell
      
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: 显示测试信息
        run: |
          Write-Host "========== 邮件发送测试 ==========" -ForegroundColor Cyan
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Yellow
          Write-Host "工作目录: $(Get-Location)" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "检查目录结构:" -ForegroundColor Cyan
          Get-ChildItem -Recurse -Filter "*.csproj" | Select-Object FullName
        shell: powershell
      
      - name: 配置User Secrets
        run: |
          Write-Host "配置User Secrets..." -ForegroundColor Yellow
          
          $testProject = "Quant.Infra.Net\Quant.Infra.Net.Tests\Quant.Infra.Net.Tests.csproj"
          
          # 设置Commercial邮件配置
          dotnet user-secrets set "Email:Commercial:Username" "${{ secrets.BREVO_USERNAME }}" --project $testProject
          dotnet user-secrets set "Email:Commercial:Password" "${{ secrets.BREVO_PASSWORD }}" --project $testProject
          
          Write-Host "✓ User Secrets配置完成" -ForegroundColor Green
        shell: powershell
      
      - name: 运行邮件发送测试
        run: |
          Write-Host "========== 开始运行测试 ==========" -ForegroundColor Yellow
          Write-Host ""
          
          $testProject = "Quant.Infra.Net\Quant.Infra.Net.Tests\Quant.Infra.Net.Tests.csproj"
          
          if (-not (Test-Path $testProject)) {
            Write-Host "✗ 找不到测试项目: $testProject" -ForegroundColor Red
            Write-Host "当前目录内容:" -ForegroundColor Yellow
            Get-ChildItem -Recurse -Directory | Select-Object FullName
            exit 1
          }
          
          Write-Host "✓ 找到测试项目: $testProject" -ForegroundColor Green
          Write-Host ""
          
          # 运行特定的测试方法
          Write-Host "运行测试: Quant.Infra.Net.Tests.EmailIntegrationTests.MVP_SendCommercial" -ForegroundColor Cyan
          dotnet test $testProject --filter "FullyQualifiedName=Quant.Infra.Net.Tests.EmailIntegrationTests.MVP_SendCommercial" --logger "console;verbosity=normal"
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host ""
            Write-Host "✓ 测试通过！邮件已发送" -ForegroundColor Green
          } else {
            Write-Host ""
            Write-Host "✗ 测试失败" -ForegroundColor Red
            exit 1
          }
        shell: powershell
      
      - name: 测试成功通知
        if: success()
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "  ✓ 邮件发送测试成功！" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "收件人:" -ForegroundColor Cyan
          Write-Host "  - yuanyuancomecome@outlook.com" -ForegroundColor White
          Write-Host "  - rong.fan1031@gmail.com" -ForegroundColor White
          Write-Host ""
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Cyan
        shell: powershell
      
      - name: 测试失败通知
        if: failure()
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Red
          Write-Host "  ✗ 邮件发送测试失败" -ForegroundColor Red
          Write-Host "========================================" -ForegroundColor Red
          Write-Host ""
          Write-Host "请检查日志并联系管理员" -ForegroundColor Yellow
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Yellow
        shell: powershell
