name: Build and Test Quant.Infra.Net

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '选择部署环境'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: '版本号或Git标签（可选）'
        required: false
        type: string
      skip_tests:
        description: '跳过测试'
        required: false
        type: boolean
        default: false

jobs:
  manual-deploy:
    runs-on: self-hosted
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 显示部署信息
        run: |
          Write-Host "========== 开始部署 ==========" -ForegroundColor Cyan
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Yellow
        shell: powershell
      
      - name: 构建.NET项目
        run: |
          Write-Host "开始构建Quant.Infra.Net项目..." -ForegroundColor Yellow
          
          $projectPath = "Quant.Infra.Net\Quant.Infra.Net\Quant.Infra.Net.csproj"
          $outputPath = "publish"
          
          if (Test-Path $outputPath) {
            Remove-Item $outputPath -Recurse -Force
          }
          
          dotnet publish $projectPath -c Release -o $outputPath
          
          Write-Host "✓ 构建完成" -ForegroundColor Green
        shell: powershell
      
      - name: 运行邮件发送测试
        run: |
          Write-Host "运行邮件发送测试..." -ForegroundColor Yellow
          
          $testProject = "Quant.Infra.Net\Quant.Infra.Net.Tests\Quant.Infra.Net.Tests.csproj"
          
          # 运行特定的测试方法
          dotnet test $testProject --filter "FullyQualifiedName=Quant.Infra.Net.Tests.EmailIntegrationTests.MVP_SendCommercial" --logger "console;verbosity=detailed"
          
          Write-Host "✓ 邮件已发送" -ForegroundColor Green
        shell: powershell
      
      - name: 部署成功通知
        if: success()
        run: |
          Write-Host "========== 部署成功 ==========" -ForegroundColor Green
          Write-Host "环境: ${{ github.event.inputs.environment }}" -ForegroundColor Cyan
          Write-Host "时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Cyan
        shell: powershell
      
      - name: 部署失败通知
        if: failure()
        run: |
          Write-Host "========== 部署失败 ==========" -ForegroundColor Red
          Write-Host "请检查日志并联系管理员" -ForegroundColor Yellow
        shell: powershell
